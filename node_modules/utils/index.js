var undersc = require('underscore');

exports.getDocNames = function(docs) {
    var docNames = [];
    for (var i = 0; i < docs.length; i++) {
        var identifierName = docs[i]['identifier'].split('-')[0];
        if (docNames.indexOf(identifierName) < 0) {
            docNames.push(identifierName);
        }
    }
    return docNames;
}

exports.getStringVersions = function(docs, rn) {
    var versions = [];
    for (var i = 0; i < docs.length; i++) {
        if (docs[i]['identifier'].split('-')[0] == rn) {
            var identifierVersion = docs[i]['identifier'].split('-')[1].split('_').join('.');
            versions.push(identifierVersion);
        }
    }
    return versions;
}

getChildrenList = function(docs, identifier) {
    for (var i = 0; i < docs.length; i++) {
        if (docs[i]['identifier'] == identifier) {
            return docs[i]['children'];
        }
    }
}

exports.getChildrenList = function(docs, identifier) {
    for (var i = 0; i < docs.length; i++) {
        if (docs[i]['identifier'] == identifier) {
            return docs[i]['children'];
        }
    }
}

getIdentifierList = function(docs, identifier) {
    var childList = getChildrenList(docs, identifier);
    if (childList) {
        return [identifier].concat(childList.map(function(childID) {return getIdentifierList(docs, childID);}));
    }
    return [identifier];
}

getOptionsDict = function(docs, identifier) {
    for (var i = 0; i < docs.length; i++) {
        if (identifier == docs[i]['identifier']) {
            return docs[i]['options'];
        }
    }
}

buildIDTree = function(docs, arr) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] instanceof Array) {
            buildIDTree(docs, arr[i]);
        } else {
            var idName = arr[i].split('-')[0];
            var idVersion = arr[i].split('-')[1].split('_').join('.');
            var idOptions = getOptionsDict(docs, arr[i]);
            arr[i] = {"tablename": idName, "tableversion": idVersion, "tableoptions": idOptions};
        }
    }
}

exports.getIdentifierTree = function(docs, identifier) {
    var idList = getIdentifierList(docs, identifier);
    buildIDTree(docs, idList);
    return(undersc.flatten(idList));
}

buildTrain = function(docs, topLevel, candidates, pathArray) {
    if (pathArray[pathArray.length - 1] == topLevel) {
        return pathArray;
    }

    for (var i = 0; i < candidates.length; i++) {
        for (var j = 0; j < docs.length; j++) {
            if (docs[j]['identifier'] == candidates[i] && docs[j]['children'].indexOf(pathArray[pathArray.length-1]) > -1) {
                pathArray.push(candidates[i]);
                return buildTrain(docs, topLevel, candidates, pathArray);
            }
        }
    }
}

exports.getDescendents = function(docs, topID, terminalID) {
    var idList = undersc.flatten(getIdentifierList(docs, topID));
    var descendentTrain = buildTrain(docs, topID, idList, [terminalID]);
    return descendentTrain;
}

exports.buildTreeRecipes = function(docs, editedArray) {
    treeRecipes = [];
    for (var i = 1; i < editedArray.length; i++) {
        var newRec = {};
        var interVers = editedArray[i].split('-')[1].split('_');
        interVers[2] = parseInt(interVers[2]) + 1;
        newRec['identifier'] = editedArray[i].split('-')[0]+'-'+interVers.join('_');
        newRec['options'] = getOptionsDict(docs, editedArray[i]);
        var oldChildren = getChildrenList(docs, editedArray[i]);
        var updatedChildVers = editedArray[i-1].split('-')[1].split('_');
        updatedChildVers[2] = parseInt(updatedChildVers[2]) + 1;
        oldChildren[oldChildren.indexOf(editedArray[i-1])] = editedArray[i-1].split('-')[0]+'-'+updatedChildVers.join('_'); 
        newRec['children'] = oldChildren;
        treeRecipes.push(newRec);
    }
    return treeRecipes;
} 
